# 多消息事务支持

在同时入队多个消息时，支持事务的方式写入，保证同时写入成功或失败。

## 事务实事方式

1. 创建事务（生成事务id/进程id，并存入事务集合）

### 修改文档

2. 读取并锁定原始文档（写入事务id）
3. 将需要修改的文档的全部内容写入事务redo操作数组
4. 修改原始文档

### 新增文档

5. 写入事务redo操作数组，添加删除方法
6. 写入文档，文档中添加事务锁

### 删除文档

7. 读取并锁定原始文档（写入事务id）
8. 写入事务redo操作数组，添加恢复方法
9. 删除文档

### 提交事务

10. 删除受影响文档中的事务标志。
11. 全部成功后，删除事务集合中的事务相关的信息


## 事务回滚

1. 单独进程检查事务相关进程是否存在，若不存在，进入回滚操作。
2. 检查事务影响的文档是否存在锁定标志，若不存在，直接删除事务。
3. 只要发现一个文档存在事务锁定标志，则按redo操作数组中的信息进行全部回滚。

# 注意

该事务为简单事务，依赖mongodb进行信息存储，对文档的修改不支持批量操作。
